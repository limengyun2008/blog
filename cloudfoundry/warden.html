<!DOCTYPE html>
<html lang="cn">
<head>
        <meta charset="utf-8">
        <title>warden及平台安全</title>
        <link rel="stylesheet" href="../theme/css/main.css">
                <link href="http://limengyun.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="limengyun's blog Atom Feed" />
                
        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">limengyun's blog </a></h1>
                <nav><ul>
                                                                                    <li class="active"><a href="../category/backend.html">backend</a></li>
                                    <li ><a href="../category/misc.html">misc</a></li>
                                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../cloudfoundry/warden.html" rel="bookmark"
           title="Permalink to warden及平台安全">warden及平台安全</a></h1>
          </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2013-06-13T00:00:00">
                Thu 13 June 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/limengyun.html">limengyun</a>
        </address>
        <p>In <a href="../category/backend.html">backend</a>. </p>
<p>tags: <a href="../tag/cloudfoundry.html">cloudfoundry</a></p>
</footer><!-- /.post-info -->      <p>warden 是整个cloudfoundry平台的基石。它负责最关键的资源控制——包括cpu，mem，disk等。
资源控制直接关系到如何让多个应用之间直接互不干扰，以及阻止恶意代码的执行，从而保证平台的安全性。
虚拟机可以很好的隔离，但这个解决方案对于隔离一个应用就显得太重量级了。</p>
<p>有一种基于linux系统内核的资源隔离技术</p>
<blockquote>
<p>Resource control is done by using <a href="http://kernel.org/doc/Documentation/cgroups/cgroups.txt">Control Groups</a>. Every container is placed in its own control group, 
where it is configured to use an equal slice of CPU compared to other containers, and the maximum amount of memory it may use.</p>
</blockquote>
<p>著名的开源资源控制项目Linux Containers(LXC)基于cgroups开发的。 
Linux Container容器是一种内核虚拟化技术，可以提供轻量级的虚拟化，以便隔离进程和资源，而且不需要提供指令解释机制以及全虚拟化的其他复杂性。
容器有效地将由单个操作系统管理的资源划分到孤立的组中，以更好地在孤立的组之间平衡有冲突的资源使用需求
简单的讲就是创建一个容器之后可以让一个进程运行在一个容器中，使用单独的文件系统，限制的网络和内存资源。
而不是像虚拟机那样相当于在一个容器中运行了一整套操作系统。</p>
<p>早期的warden就是使用的LXC，但后来发现不太能提供外层完整的控制接口，而且LXC的很多功能也并不需要，warden的开发人员就自己实现了一个更满足需求的“container”，仅用了1千行C代码。</p>
<p>我并没有深入研究warden的源代码逻辑，只是局限在它提供给上层的功能上。一般说warden实际上指的是warden server，上层DEA通过warden client来调用warden server提供的api创建并控制container
container可以添加诸多限制，且container之间互相隔离。应用的实例最终在container中运行。</p>
<h2>安装</h2>
<p><a href="https://github.com/youdao-cf/docs/blob/master/install/warden.html.md">链接</a></p>
<h2>配置</h2>
<p>默认的配置大部分都不用修改，除了一个隐藏的配置可能会有问题：</p>
<div class="highlight"><pre><span class="n">port</span><span class="o">:</span>
  <span class="n">pool_start_port</span><span class="o">:</span> <span class="mi">10000</span>
  <span class="n">pool_size</span><span class="o">:</span> <span class="mi">10000</span>
</pre></div>


<p>在warden/lib/warden/config.rb中对这个配置是这么处理的</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">ip_local_port_range</span>
  <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;/proc/sys/net/ipv4/ip_local_port_range&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_i</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">port_defaults</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">ephemeral_stop</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">ip_local_port_range</span>
  <span class="n">start</span> <span class="o">=</span> <span class="n">ephemeral_stop</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="n">stop</span> <span class="o">=</span> <span class="mi">65000</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="n">count</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span>

  <span class="p">{</span>
    <span class="s2">&quot;pool_start_port&quot;</span> <span class="o">=&gt;</span> <span class="n">start</span><span class="p">,</span>
    <span class="s2">&quot;pool_size&quot;</span>       <span class="o">=&gt;</span> <span class="n">count</span><span class="p">,</span>
  <span class="p">}</span>
<span class="k">end</span>
</pre></div>


<p>如果没有在配置文件中定义，则使用/proc/sys/net/ipv4/ip_local_port_range文件中的数值，但是这文件的值是受linux
系统设置影响的，在我的centos VPS上被设置成了65000，那么pool_size就会为0，会报错。</p>
<p>为了保险起见，最好还是在配置文件里面按照上面的示范加上关于port的配置。</p>
<h2>功能示例</h2>
<p>安装完成后，在warden/bin 目录下有一个脚本。它可以用来测试warden所提供的所有功能，也可以用来调试已有的warden container。</p>
<div class="highlight"><pre><span class="p">[</span><span class="n">vcap</span><span class="err">@</span><span class="n">yae</span> <span class="n">warden</span><span class="p">]</span><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">warden</span>
</pre></div>


<p>列出正在运行的所有container，一个container可以理解为一个简易的操作系统。</p>
<div class="highlight"><pre><span class="n">warden</span><span class="o">&gt;</span> <span class="n">list</span>
<span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mi">16u</span><span class="n">cmjgeeil</span>
<span class="n">handles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mi">16u</span><span class="n">cmjgeeik</span>
<span class="n">handles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="mi">16u</span><span class="n">cket2otf</span>
<span class="n">handles</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:</span> <span class="mi">16u</span><span class="n">ci088oas</span>
<span class="n">handles</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="mi">16u</span><span class="n">cuupdlgb</span>
<span class="n">handles</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">:</span> <span class="mi">16u</span><span class="n">cuupdlgt</span>
<span class="n">handles</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">:</span> <span class="mi">16u</span><span class="n">cuupdlh3</span>
<span class="n">handles</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">:</span> <span class="mi">16u</span><span class="n">cuupdlh5</span>
</pre></div>


<p>查看或设置一个container的内存限制</p>
<div class="highlight"><pre><span class="n">warden</span><span class="o">&gt;</span> <span class="n">limit_memory</span> <span class="o">--</span><span class="n">handle</span> <span class="mi">16u</span><span class="n">cuupdlh5</span> 
<span class="n">limit_in_bytes</span> <span class="o">:</span> <span class="mi">603979776</span>
</pre></div>


<p>查看在某一个container下运行的程序</p>
<div class="highlight"><pre><span class="n">warden</span><span class="o">&gt;</span> <span class="n">run</span> <span class="o">--</span><span class="n">handle</span> <span class="mi">16u</span><span class="n">cuupdlh5</span> <span class="o">--</span><span class="n">script</span> <span class="s">&quot;ps xf&quot;</span>
  <span class="n">PID</span> <span class="n">TTY</span>      <span class="n">STAT</span>   <span class="n">TIME</span> <span class="n">COMMAND</span>
  <span class="mi">100</span> <span class="o">?</span>        <span class="n">Ss</span>     <span class="mi">0</span><span class="o">:</span><span class="mo">00</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
  <span class="mi">101</span> <span class="o">?</span>        <span class="n">R</span>      <span class="mi">0</span><span class="o">:</span><span class="mo">00</span>  <span class="err">\</span><span class="n">_</span> <span class="n">ps</span> <span class="n">xf</span>
   <span class="mi">22</span> <span class="o">?</span>        <span class="n">Ss</span>     <span class="mi">0</span><span class="o">:</span><span class="mo">00</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>
   <span class="mi">23</span> <span class="o">?</span>        <span class="n">S</span>      <span class="mi">0</span><span class="o">:</span><span class="mo">00</span>  <span class="err">\</span><span class="n">_</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span> <span class="p">.</span><span class="o">/</span><span class="n">startup</span> <span class="o">-</span><span class="n">p</span> <span class="mi">10446</span>
   <span class="mi">25</span> <span class="o">?</span>        <span class="n">S</span>      <span class="mi">0</span><span class="o">:</span><span class="mo">00</span>      <span class="err">\</span><span class="n">_</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span> <span class="p">.</span><span class="o">/</span><span class="n">startup</span> <span class="o">-</span><span class="n">p</span> <span class="mi">10446</span>
   <span class="mi">28</span> <span class="o">?</span>        <span class="n">Sl</span>     <span class="mi">1</span><span class="o">:</span><span class="mi">17</span>          <span class="err">\</span><span class="n">_</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">vcap</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="p">.</span><span class="n">jdk</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">java</span> <span class="o">-</span><span class="n">Xss1m</span> <span class="o">-</span><span class="n">Dresin</span><span class="p">.</span><span class="n">home</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">vcap</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">resin</span><span class="o">-</span><span class="mf">3.0.21</span> <span class="o">-</span><span class="n">Dserver</span><span class="p">.</span><span class="n">root</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">vcap</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">resin</span><span class="o">-</span><span class="mf">3.0.21</span> <span class="o">-</span><span class="n">Djava</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">logging</span><span class="p">.</span><span class="n">manager</span><span class="o">=</span><span class="n">com</span><span class="p">.</span><span class="n">caucho</span><span class="p">.</span><span class="n">log</span><span class="p">.</span><span class="n">LogManagerImpl</span> <span class="o">-</span><span class="n">Djavax</span><span class="p">.</span><span class="n">management</span><span class="p">.</span><span class="n">builder</span><span class="p">.</span><span class="n">initial</span><span class="o">=</span><span class="n">com</span><span class="p">.</span><span class="n">caucho</span><span class="p">.</span><span class="n">jmx</span><span class="p">.</span><span class="n">MBeanServerBuilderImpl</span> <span class="n">com</span><span class="p">.</span><span class="n">caucho</span><span class="p">.</span><span class="n">server</span><span class="p">.</span><span class="n">resin</span><span class="p">.</span><span class="n">Resin</span> <span class="o">-</span><span class="n">conf</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">vcap</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">resin</span><span class="p">.</span><span class="n">conf</span>
</pre></div>


<p>上面显示的结果就是一个java应用的进程。</p>
<p>在命令行输入help可以得到warden的全部功能</p>
<div class="highlight"><pre><span class="n">warden</span><span class="o">&gt;</span> <span class="n">help</span>

    <span class="n">copy_in</span>       <span class="n">Copy</span> <span class="n">files</span><span class="o">/</span><span class="n">directories</span> <span class="n">into</span> <span class="n">the</span> <span class="n">container</span><span class="p">.</span>
    <span class="n">copy_out</span>      <span class="n">Copy</span> <span class="n">files</span><span class="o">/</span><span class="n">directories</span> <span class="n">out</span> <span class="n">of</span> <span class="n">the</span> <span class="n">container</span><span class="p">.</span>
    <span class="n">create</span>        <span class="n">Create</span> <span class="n">a</span> <span class="n">container</span><span class="p">,</span> <span class="n">optionally</span> <span class="n">pass</span> <span class="n">options</span><span class="p">.</span>
    <span class="n">destroy</span>       <span class="n">Shutdown</span> <span class="n">a</span> <span class="n">container</span><span class="p">.</span>
    <span class="n">echo</span>          <span class="n">Echo</span> <span class="n">a</span> <span class="n">message</span><span class="p">.</span>
    <span class="n">info</span>          <span class="n">Show</span> <span class="n">metadata</span> <span class="k">for</span> <span class="n">a</span> <span class="n">container</span><span class="p">.</span>
    <span class="n">limit_disk</span>    <span class="n">set</span> <span class="n">or</span> <span class="n">get</span> <span class="n">the</span> <span class="n">disk</span> <span class="n">limit</span> <span class="k">for</span> <span class="n">the</span> <span class="n">container</span><span class="p">.</span>
    <span class="n">limit_memory</span>  <span class="n">Set</span> <span class="n">or</span> <span class="n">get</span> <span class="n">the</span> <span class="n">memory</span> <span class="n">limit</span> <span class="k">for</span> <span class="n">the</span> <span class="n">container</span><span class="p">.</span>
    <span class="n">link</span>          <span class="n">Do</span> <span class="n">blocking</span> <span class="n">read</span> <span class="n">on</span> <span class="n">results</span> <span class="n">from</span> <span class="n">a</span> <span class="n">job</span><span class="p">.</span>
    <span class="n">list</span>          <span class="n">List</span> <span class="n">containers</span><span class="p">.</span>
    <span class="n">net_in</span>        <span class="n">Forward</span> <span class="n">port</span> <span class="n">on</span> <span class="n">external</span> <span class="n">interface</span> <span class="n">to</span> <span class="n">container</span><span class="p">.</span>
    <span class="n">net_out</span>       <span class="n">Allow</span> <span class="n">traffic</span> <span class="n">from</span> <span class="n">the</span> <span class="n">container</span> <span class="n">to</span> <span class="n">address</span><span class="p">.</span>
    <span class="n">ping</span>          <span class="n">Ping</span> <span class="n">warden</span><span class="p">.</span>
    <span class="n">run</span>           <span class="n">Short</span> <span class="n">hand</span> <span class="k">for</span> <span class="n">spawn</span><span class="p">(</span><span class="n">stream</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="n">i</span><span class="p">.</span><span class="n">e</span><span class="p">.</span> <span class="n">spawns</span> <span class="n">a</span> <span class="n">command</span><span class="p">,</span> <span class="n">streams</span> <span class="n">the</span> <span class="n">result</span><span class="p">.</span>
    <span class="n">spawn</span>         <span class="n">Spawns</span> <span class="n">a</span> <span class="n">command</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">container</span> <span class="n">and</span> <span class="n">returns</span> <span class="n">the</span> <span class="n">job</span> <span class="n">id</span><span class="p">.</span>
    <span class="n">stop</span>          <span class="n">Stop</span> <span class="n">all</span> <span class="n">processes</span> <span class="n">inside</span> <span class="n">a</span> <span class="n">container</span><span class="p">.</span>
    <span class="n">stream</span>        <span class="n">Do</span> <span class="n">blocking</span> <span class="n">stream</span> <span class="n">on</span> <span class="n">results</span> <span class="n">from</span> <span class="n">a</span> <span class="n">job</span><span class="p">.</span>
    <span class="n">help</span>          <span class="n">Show</span> <span class="n">help</span><span class="p">.</span>

<span class="n">Use</span> <span class="o">--</span><span class="n">help</span> <span class="n">with</span> <span class="n">each</span> <span class="n">command</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="p">.</span>
</pre></div>


<p>详细的功能列表参见warden server源代码下的README文件：<a href="https://github.com/cloudfoundry/warden/tree/master/warden">地址</a></p>
<h2>centos TIPS</h2>
<p>warden源代码的readme里阐述了container的文件系统的实现方式</p>
<blockquote>
<p>Every container gets a private root filesystem. 
This filesystem is created by stacking a read-only filesytem and a read-write filesystem. 
This is implemented by using aufs on Ubuntu versions from 10.04 up to 11.10, and overlayfs on Ubuntu 12.04.</p>
</blockquote>
<p>在centos上没有这两个文件系统，但warden专门为centos做了个适配，使用了默认文件系统做替代，
在创建container的时候把 container文件系统的/目录设置为ro，把 /dev /etc /home /sbin /tmp 等几个目录设置为rw ，（代码如下）</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">setup_fs_other</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">mkdir</span> <span class="o">-</span><span class="nx">p</span> <span class="nx">tmp</span><span class="o">/</span><span class="nx">rootfs</span> <span class="nx">mnt</span>
  <span class="nx">mkdir</span> <span class="o">-</span><span class="nx">p</span> <span class="nx">$rootfs_path</span><span class="o">/</span><span class="nx">proc</span>

  <span class="nx">mount</span> <span class="o">-</span><span class="nx">n</span> <span class="o">--</span><span class="nx">bind</span> <span class="nx">$rootfs_path</span> <span class="nx">mnt</span>
  <span class="nx">mount</span> <span class="o">-</span><span class="nx">n</span> <span class="o">--</span><span class="nx">bind</span> <span class="o">-</span><span class="nx">o</span> <span class="nx">remount</span><span class="p">,</span><span class="nx">ro</span> <span class="nx">$rootfs_path</span> <span class="nx">mnt</span>

  <span class="nx">overlay_directory_in_rootfs</span> <span class="o">/</span><span class="nx">dev</span> <span class="nx">rw</span>
  <span class="nx">overlay_directory_in_rootfs</span> <span class="o">/</span><span class="nx">etc</span> <span class="nx">rw</span>
  <span class="nx">overlay_directory_in_rootfs</span> <span class="o">/</span><span class="nx">home</span> <span class="nx">rw</span>
  <span class="nx">overlay_directory_in_rootfs</span> <span class="o">/</span><span class="nx">sbin</span> <span class="nx">rw</span>

  <span class="nx">mkdir</span> <span class="o">-</span><span class="nx">p</span> <span class="nx">tmp</span><span class="o">/</span><span class="nx">rootfs</span><span class="o">/</span><span class="nx">tmp</span>
  <span class="nx">chmod</span> <span class="mi">777</span> <span class="nx">tmp</span><span class="o">/</span><span class="nx">rootfs</span><span class="o">/</span><span class="nx">tmp</span>
  <span class="nx">overlay_directory_in_rootfs</span> <span class="o">/</span><span class="nx">tmp</span> <span class="nx">rw</span>
<span class="p">}</span>
</pre></div>


<p>正常情况下在这几个目录读写文件不会有问题，但是DEA在container中操作的时候会在根目录创建一个目录/app,放置内容
问题就在这: /目录是readonly的  不可能创建得了文件夹。</p>
<p>有人会觉得直接把/设置为rw不就可以了么。warden在centos上是根据一个文件夹（默认为/tmp/warden/rootfs/）作为文件系统模板来创建文件系统的，
设置/为rw会导致文件系统模板收到污染，即任何在container中进行的操作 会直接反映到这个文件夹上。</p>
<p>最后才用了一个笨办法：加上一行代码</p>
<div class="highlight"><pre><span class="n">overlay_directory_in_rootfs</span> <span class="o">/</span><span class="n">app</span> <span class="n">rw</span>
</pre></div>


<p>即创建container时新添加一个/app目录为rw。</p>
<p>后来又发现centos 上的container里无法创建软连接。但上层组件dea和buildpack部分代码使用了软链接，导致必须修改这些使用到了软链接的与warden相关的代码。
那既然这样，上面的做法就没有必要了，因为如果使用centos上的warden，不论如何都要修改上层dea代码，
还不如彻底一点，把dea所有在warden container中的操作都在/home/vcap/app目录下进行，不再创建根目录下的/app，
同时也不要使用任何软链接。这样warden就可以完全不用修改，保持跟官方的一致。
但目前为止，我们仍然采用的是修改后的warden代码以保证上层代码不出错。</p>
<p>dea强依赖warden，但在非ubuntu系统上warden和dea无法正常协同运行，这应该是阻碍大部分人在其他平台上成功运行cloudfoundry的原因。</p>
    </div><!-- /.entry-content -->
    
  </article>
</section>
        <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://getpelican.com/">Pelican</a></li>
                                                    <li><a href="http://python.org/">Python.org</a></li>
                                                    <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                                                    <li><a href="/pages/markdown-syntax.html">Markdown Syntax</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>友情链接</h2>
                        <ul>
                            <li><a href="http://limengyun.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://huihui.cn/?keyfrom=limengyun.com">网易惠惠</a></li>
                                                    <li><a href="http://www.xiaoshuov.com">xiaoshuov</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>&copy; copyright 2013. <a href="http://limengyun.com">limengyun.com</a>, thanks for visiting!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37781337-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>