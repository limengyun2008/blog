<!DOCTYPE html>
<html lang="cn">
<head>
        <meta charset="utf-8">
        <title>Health Manager</title>
        <link rel="stylesheet" href="../theme/css/main.css">
                <link href="http://limengyun.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="limengyun's blog Atom Feed" />
                
        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">limengyun's blog </a></h1>
                <nav><ul>
                                                                                    <li class="active"><a href="../category/backend.html">backend</a></li>
                                    <li ><a href="../category/misc.html">misc</a></li>
                                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../cloudfoundry/hm.html" rel="bookmark"
           title="Permalink to Health Manager">Health Manager</a></h1>
          </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2013-06-13T10:00:00">
                Thu 13 June 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/limengyun.html">limengyun</a>
        </address>
        <p>In <a href="../category/backend.html">backend</a>. </p>
<p>tags: <a href="../tag/cloudfoundry.html">cloudfoundry</a></p>
</footer><!-- /.post-info -->      <p>Health Manager (简称HM) 主要负责监控app的状态，确保已经启动的app处于running状态，以及这些app的版本和instance数量是正确的。
这些确保机制主要是通过维护应用状态实现的，每个app有一个Actual State 实际运行状态，用来比较它和app的Desired State 期望状态。
当不匹配的情况出现的时候，就要把app的状态调整到期望状态，比如通过start/stop命令来控制missing/extra的instance。</p>
<p>HM也收集和提供app的统计信息，这些统计信息由CC获取和使用。</p>
<p>HM并不是必要的，失去HM的影响仅仅是crash的应用无法自动重启。</p>
<h2>HM对instance的调整策略</h2>
<p>调整主要出现在两种情况下：</p>
<ul>
<li>对Nats信息的反应，比如droplet.exited</li>
<li>周期性的获取app的状态，寻找异常</li>
</ul>
<h2>droplet.exited 信号</h2>
<p>有三种场景下 droplet.exited会接收到：</p>
<ul>
<li>app被显式地stop了，这种情况不需要对app进行调整</li>
<li>DEA撤离。当有DEA撤离的时候，属于该DEA的instance应该在其他地方重启，HM应该初始化这个重启。</li>
<li>app崩溃。崩溃的instance应该被重启，除非这个instance短时间内崩溃多次，就会被标识为flapping。</li>
</ul>
<h2>flapping instance</h2>
<p>app的一个instance当在flapping_timeout的秒数内崩溃了flapping_death次就会被标记为flapping。可能的原因有：</p>
<ul>
<li>instance已经完全毁坏，最直接的无法启动了</li>
<li>instance有bug导致每过一会就崩溃</li>
<li>instance依赖外部世界的服务或者CF提供的服务，当这个依赖不可用的时候导致instance反复崩溃</li>
</ul>
<p>原理上讲，HM会尽最大努力在避免IO冲突的情况下去重启flapping instance，同时切断彻底崩溃的instance占用的资源。为了实现这些，有下列可以配置的策略：</p>
<ul>
<li>根据min_restart_delay配置的秒数作为delay来初始化instance的重启</li>
<li>对于每次崩溃，delay翻番，但是不会超过max_restart_delay配置的秒数</li>
<li>每次计算delay都会加入一个随机的噪音，噪音数不会超过delay_time_noise配置的秒数</li>
<li>如果flapping instance崩溃的数量超过giveup_crash_number，就放弃该instance的重启。</li>
</ul>
<h2>Heartbeat 处理</h2>
<p>DEA周期性的会把heartbeat信息发送到Nats总线上。这些heartbeat包括了DEA的识别消息和所有该DEA上的instance的信息。
heartbeat会被用来管理missing和extra 的instance。Missing instance会被要求启动，extra的instance会被要求停止。Droplet对象会跟踪自身每个instance的heartbeat的每个version。
一个当前version的instance如果没有在droplet_lost的秒数内收到heartbeat就被认为是missing。
以下是一个有3个Running的Instance的heartbeat的实例：</p>
<div class="highlight"><pre><span class="p">{</span><span class="s">&quot;timestamp&quot;</span><span class="o">:</span><span class="mf">1371542789.3913922</span><span class="p">,</span><span class="s">&quot;message&quot;</span><span class="o">:</span><span class="s">&quot;Actual: #process_heartbeat: {</span><span class="se">\&quot;</span><span class="s">droplets</span><span class="se">\&quot;</span><span class="s">:[ {</span><span class="se">\&quot;</span><span class="s">cc_partition</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">ng</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">droplet</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">26b2ba8b-5143-46c9-9a9c-4d336066bf54</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">version</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">2c7d4ccf-825e-4883-aa9fd6d7572df84f</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">instance</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">ad250f48ff181f1b97df1233914bb419</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">index</span><span class="se">\&quot;</span><span class="s">:0,</span><span class="se">\&quot;</span><span class="s">state</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">RUNNING</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">state_timestamp</span><span class="se">\&quot;</span><span class="s">:1371389265.22629},</span>
<span class="p">{</span><span class="err">\</span><span class="s">&quot;cc_partition</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">ng</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">droplet</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">cb58ffe4-4161-4b88-aa89-8c2681695f44</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">version</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">e60abbbf-ca23-4e33-97269fc0eeb20cab</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">instance</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">a0f8fc83aed024712e0f6cbdfb79df87</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">index</span><span class="se">\&quot;</span><span class="s">:0,</span><span class="se">\&quot;</span><span class="s">state</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">RUNNING</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">state_timestamp</span><span class="se">\&quot;</span><span class="s">:1371389245.8968444},</span>
<span class="p">{</span><span class="err">\</span><span class="s">&quot;cc_partition</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">ng</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">droplet</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">517dda82-e5bc-4d1d-b7b5-18bdae4257ad</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">version</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">08764835-78a1-426c-b17abd7c492b0768</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">instance</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">d762b1a691ceb94b09f5a975357e562a</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">index</span><span class="se">\&quot;</span><span class="s">:0,</span><span class="se">\&quot;</span><span class="s">state</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">RUNNING</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">state_timestamp</span><span class="se">\&quot;</span><span class="s">:1371533092.2616484}],</span>
<span class="err">\</span><span class="s">&quot;dea</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">0-ed133b25d81b3805ac63d1c2d31b90b3</span><span class="se">\&quot;</span><span class="s">,</span><span class="se">\&quot;</span><span class="s">prod</span><span class="se">\&quot;</span><span class="s">:false}&quot;</span><span class="p">,</span><span class="s">&quot;log_level&quot;</span><span class="o">:</span><span class="s">&quot;debug&quot;</span><span class="p">,</span><span class="s">&quot;source&quot;</span><span class="o">:</span><span class="s">&quot;hm&quot;</span><span class="p">,</span><span class="s">&quot;data&quot;</span><span class="o">:</span><span class="p">{},</span><span class="s">&quot;thread_id&quot;</span><span class="o">:</span><span class="mi">10743820</span><span class="p">,</span><span class="s">&quot;fiber_id&quot;</span><span class="o">:</span><span class="mi">12336320</span><span class="p">,</span><span class="s">&quot;process_id&quot;</span><span class="o">:</span><span class="mi">28730</span><span class="p">,</span><span class="s">&quot;file&quot;</span><span class="o">:</span><span class="s">&quot;/home/vcap/health_manager/lib/health_manager/actual_state.rb&quot;</span><span class="p">,</span><span class="s">&quot;lineno&quot;</span><span class="o">:</span><span class="mi">86</span><span class="p">,</span><span class="s">&quot;method&quot;</span><span class="o">:</span><span class="s">&quot;process_heartbeat&quot;</span><span class="p">}</span>
</pre></div>


<h2>HM的配置</h2>
<p>HM是为数不多的在centos上能修改几个配置就能无脑正常运行的cloudfoundry组件之一（还有一个就是gorouter）</p>
<p>但有几点要注意：
HM在源文件constants.rb里提供了一套缺省的配置，值得注意的是HM缺省配置中cc_partition是default，
而CF 2.0组件cloud_controller 启动时缺省的配置是cc_partition=ng，这种情况下HM不会跟CC有任何交互，
我们猜测可能的原因是有一段时间1.0和2.0的CC共存，
所以需要用这个东西告诉HM将这两个不同的版本区分开</p>
<p>新增一行 cc_partition=ng (或者您为cc启动时配置的值)</p>
<p>bulk_api下host 要填写CC的域名或者IP</p>
    </div><!-- /.entry-content -->
 
   
    <div class="comments">
      <h2>Comments !</h2>
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=1531463" async=""></script>
<!-- UY END -->
    </div>


    
  </article>
</section>
        <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://getpelican.com/">Pelican</a></li>
                                                    <li><a href="http://python.org/">Python.org</a></li>
                                                    <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                                                    <li><a href="/pages/markdown-syntax.html">Markdown Syntax</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>友情链接</h2>
                        <ul>
                            <li><a href="http://limengyun.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://huihui.cn/?keyfrom=limengyun.com">网易惠惠</a></li>
                                                    <li><a href="http://www.xiaoshuov.com">xiaoshuov</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>&copy; copyright 2013. <a href="http://limengyun.com">limengyun.com</a>, thanks for visiting!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37781337-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
</body>
</html>