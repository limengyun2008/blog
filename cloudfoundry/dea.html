<!DOCTYPE html>
<html lang="cn">
<head>
        <meta charset="utf-8">
        <title>DEA 和 buildpack</title>
        <link rel="stylesheet" href="../theme/css/main.css">
                <link href="http://limengyun.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="limengyun's blog Atom Feed" />
                
        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">limengyun's blog </a></h1>
                <nav><ul>
                                                                                    <li class="active"><a href="../category/backend.html">backend</a></li>
                                    <li ><a href="../category/misc.html">misc</a></li>
                                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../cloudfoundry/dea.html" rel="bookmark"
           title="Permalink to DEA 和 buildpack">DEA 和 buildpack</a></h1>
          </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2013-06-13T10:00:00">
                Thu 13 June 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="../author/limengyun.html">limengyun</a>
        </address>
        <p>In <a href="../category/backend.html">backend</a>. </p>
<p>tags: <a href="../tag/cloudfoundry.html">cloudfoundry</a></p>
</footer><!-- /.post-info -->      <h2>术语</h2>
<p>dea组件的全称是 droplet execution agency， droplet是cloudfoundry自创的一个概念，它是一个app的可运行实例配合实例启停脚本的压缩包。</p>
<p>举例来说，如果我们要让一个php app程序运行，我们将代码下载之后需要做什么呢？</p>
<ul>
<li>首先需要需要下载一个apache，</li>
<li>然后配置apache</li>
<li>最后将启动命令写入一个脚本。</li>
</ul>
<p>那如果我们将代码+apache+脚本一起打成一个压缩包，在其他服务器上启动这个应用的多个实例的时候只需要下载这个压缩包之后解压，启动脚本即可。
这个机制也是整个cloudfoundry实现应用分布式的关键。</p>
<ul>
<li>这个压缩包即为 droplet</li>
<li>将用户代码和服务器打包压缩生成droplet的过程叫 staging</li>
<li>针对不同类型应用专门编写staging程序叫 buildpack</li>
<li>解压运行droplet的组件叫dea。</li>
</ul>
<h2>staging和running droplet的过程</h2>
<p>在1.0中，staging 是由专门的组件stager来完成的，在2.0中去掉了stager改为直接在dea中进行staging。</p>
<p>官方专门针对staging和running的流程撰写了文档： <a href="http://docs.cloudfoundry.com/docs/running/architecture/how-applications-are-staged.html">文章链接</a></p>
<h2>应用对外提供服务的过程。</h2>
<p>dea上的应用流量无论有多大，对dea的影响都微乎其微。
因为dea不对外提供服务，dea控制的container才对外提供服务。
router和dea会定时通过NATS通信，dea将dea下的container的ip，host，port等消息报告给router，这一部分在<a href="./nats.html">NATS细节</a>中已经说明过。</p>
<h2>dea directory server和file api server</h2>
<p>dea启动时会附带启动一个file api server，而dea directory server的启动则是单独进行的，代码在dea/go目录下。
这两个server的区别在于</p>
<p>dea directory server 会向router注册，外部可以访问到dea directory server。从而所有跟dea相关的上传（上传droplet）和下载（获取各种文件内容，如log文件）都是直接通过dea directory server来进行的。
file api server起一个验证并返回请求真实路径的作用
比如执行cf logs XXX -t命令，表面上看起来是客户端cf向cloud controller发起请求，但实际上是cloud controller 重定向到dea directory server来提供服务的</p>
<div class="highlight"><pre><span class="n">Getting</span> <span class="n">logs</span> <span class="k">for</span> <span class="mi">23423</span> <span class="err">#</span><span class="mi">0</span><span class="o">&gt;&gt;&gt;</span>
<span class="nl">REQUEST:</span> <span class="n">GET</span> <span class="n">http</span><span class="o">:</span><span class="c1">//api.cf2.youdao.com/v2/apps/de48824b-8243-4218-8b52-d92c974453f8/instances/0/files/logs</span>
<span class="nl">REQUEST_HEADERS:</span>
  <span class="n">Authorization</span> <span class="o">:</span> <span class="n">bearer</span> <span class="n">eyJhbGciOiJIUzI1NiJ9</span><span class="p">.</span><span class="n">eyJqdGkiOiIzZjMyMTNmZS1jODMzLTQ4YmMtYTYwZi00ZmM0NTAzODk0ZjAiLCJzdWIiOiJkNmE2M2Q1OC04ZmQ4LTRhNzUtOGZhOC1mNWI2ZDJjOGQwMDAiLCJzY29wZSI6WyJwYXNzd29yZC53cml0ZSIsImNsb3VkX2NvbnRyb2xsZXIud3JpdGUiLCJvcGVuaWQiLCJjbG91ZF9jb250cm9sbGVyLnJlYWQiXSwiY2xpZW50X2lkIjoiY2YiLCJjaWQiOiJjZiIsInVzZXJfaWQiOiJkNmE2M2Q1OC04ZmQ4LTRhNzUtOGZhOC1mNWI2ZDJjOGQwMDAiLCJ1c2VyX25hbWUiOiJsaW15IiwiZW1haWwiOiJsaW15QHJkLm5ldGVhc2UuY29tIiwiaWF0IjoxMzcxMzcyNjQyLCJleHAiOjEzNzE5Nzc0NDIsImlzcyI6Imh0dHA6Ly9sb2NhbGhvc3Q6ODA4MC91YWEvb2F1dGgvdG9rZW4iLCJhdWQiOlsib3BlbmlkIiwiY2xvdWRfY29udHJvbGxlciIsInBhc3N3b3JkIl19</span><span class="p">.</span><span class="n">cd11MxTrbCCpG_5fU9_DV1_bE9Nz_2lQ_c1kari1WXI</span>
  <span class="n">Content</span><span class="o">-</span><span class="n">Length</span> <span class="o">:</span> <span class="mi">0</span>
<span class="p">.</span>  <span class="n">RESPONSE</span><span class="o">:</span> <span class="p">[</span><span class="mi">302</span><span class="p">]</span>
<span class="nl">RESPONSE_HEADERS:</span>
  <span class="n">connection</span> <span class="o">:</span> <span class="n">keep</span><span class="o">-</span><span class="n">alive</span>
  <span class="n">content</span><span class="o">-</span><span class="n">length</span> <span class="o">:</span> <span class="mi">0</span>
  <span class="n">content</span><span class="o">-</span><span class="n">type</span> <span class="o">:</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span><span class="p">;</span><span class="n">charset</span><span class="o">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
  <span class="n">date</span> <span class="o">:</span> <span class="n">Sun</span><span class="p">,</span> <span class="mi">16</span> <span class="n">Jun</span> <span class="mi">2013</span> <span class="mi">08</span><span class="o">:</span><span class="mi">51</span><span class="o">:</span><span class="mi">37</span> <span class="n">GMT</span>
  <span class="n">location</span> <span class="o">:</span> <span class="n">http</span><span class="o">:</span><span class="c1">//882aa9de3cfa35c4e06a6f5613f0df2d.cf2.youdao.com/instance_paths/b6d11bf2865189aafe0a4be4133688b7?hmac=cc48aa1aa305154ea4e49e8ee33c1ee4a3bbb9ddccd626b73f0a6ed9fe7d6d191a79ecf78b680e5e252ba8948e7ee444029e38ce216a9b828b3898e49dc49a06&amp;path=logs&amp;timestamp=1371372696</span>
  <span class="n">server</span> <span class="o">:</span> <span class="n">nginx</span>
  <span class="n">x</span><span class="o">-</span><span class="n">frame</span><span class="o">-</span><span class="n">options</span> <span class="o">:</span> <span class="n">sameorigin</span>
  <span class="n">x</span><span class="o">-</span><span class="n">vcap</span><span class="o">-</span><span class="n">request</span><span class="o">-</span><span class="n">id</span> <span class="o">:</span> <span class="mf">76e95020</span><span class="o">-</span><span class="n">cd2c</span><span class="o">-</span><span class="mi">4</span><span class="n">ba8</span><span class="o">-</span><span class="n">b41b</span><span class="o">-</span><span class="n">d99e8638e7aa</span>
  <span class="n">x</span><span class="o">-</span><span class="n">xss</span><span class="o">-</span><span class="n">protection</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="n">mode</span><span class="o">=</span><span class="n">block</span>
</pre></div>


<p>dea directory server 收到类似http://882aa9de3cfa35c4e06a6f5613f0df2d.cf2.youdao.com/instance_paths/b6d11bf2865189aafe0a4be4133688b7?hmac=cc48aa1aa305154ea4e49e8ee33c1ee4a3bbb9ddccd626b73f0a6ed9fe7d6d191a79ecf78b680e5e252ba8948e7ee444029e38ce216a9b828b3898e49dc49a06&amp;path=logs&amp;timestamp=1371372696
这样的请求后会向file api server 发起请求，file api server根据hmac 判断请求是否合法，如果合法就返回log文件在操作系统上的真实地址，最后由dea directory server 返回log的内容。</p>
<h2>配置</h2>
<div class="highlight"><pre><span class="nl">domain:</span> <span class="err">你的平台域名。</span>
</pre></div>


<p>这个配置项在默认配置中没有，但上面提到dea directory server会向router注册对外提供服务，
在lib/dea/directory_server_v2.rb提供给外部访问路径的时候如果domain值为nil，会导致directory server无法被访问。</p>
<div class="highlight"><pre><span class="n">def</span> <span class="n">external_hostname</span>
  <span class="s">&quot;#{uuid}.#{domain}&quot;</span>
<span class="n">end</span>
</pre></div>


<p>此外，还需要特别注意你的ruby安装路径，配置项中与ruby相关的路径要填对。</p>
<h2>自定义buildpack支持</h2>
<p>如果想要cloudfoundry支持一门新的语言或框架，自定义一个buildpack就可以了，
比如我们就将官方的java buildpack修改为支持ant+ivy编译，且从tomcat改为使用resin。
（可真别以为J2EE架构下一个war包能在resin下跑就一定能在tomcat下跑）
这样就可以直接上传源代码而不用上传war包，且与公司的习惯保持一致。。</p>
<p>每一种语言只有一种buildpack，不同类别的应用打包是在buildpack代码里面进行区分的。在buildpacks/vendor目录下，官方提供了三种语言（java，nodejs，ruby）的若干种应用类型的支持，同时也提供了一种方便添加自定义buildpack支持的机制。</p>
<p>新增添一个语言的buildpack需要实现以下三个脚本：</p>
<ul>
<li>./bin/detect 检查应用的类型，例如是一个sinatra应用还是一个rails应用，以供compile脚本使用</li>
<li>./bin/compile  打包的主脚本，根据detect的结果选择打包的方式。</li>
<li>./bin/release  输出自定义的启动命令等相关信息，以便写入到最终的启动脚本。</li>
</ul>
<p>dea会遍历所有的detect脚本，如果你编写的detect脚本满足条件，就会选择对应的compile脚本执行。</p>
<p>在执行你编写的compile脚本之前，dea已经给创建好了container，然后下载并解压好了代码，compile的内容就是根据这个代码要怎么打包。
按照这个方式，怎么编写compile脚本就取决于你的实际情况，可以使用shell 也可以使用ruby脚本。写之前参考一下已有的buildpack就能了解思路。</p>
<h4>注意1：</h4>
<p>官方或开源第三方的buildpack在staging的时候基本都通过http下载一些东西，比如apache等等，关键在于这些地址都是在amazon s3上。
在天朝的网络下，采用这种方式就要看GFW的心情了，要正常使用最好把那些下载地址全部换成内网地址。</p>
<h4>注意2：</h4>
<p>同样，有些buildpack 会将/home/vcap/app  软连接到/app/app   然后再在/app/app中进行操作。
但在centos 6上使用默认文件系统实现的warden container 不具备完整的软连接功能（无法cd进入软连接后的目录，详情见warden的cent OS tip），
所以想要在centos上正常使用仍然需要修改这部分代码。</p>
<h4>提示：</h4>
<p>http://www.appfog.com 是一个基于cloudfoundry的paas，他自定义了许多语言的支持并在github上开源出来（github： https://github.com/appfog/ ）。 </p>
    </div><!-- /.entry-content -->
        <div class="comments">
      <h2>Comments !</h2>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_identifier = "cloudfoundry/dea.html";
        //var disqus_url = "../cloudfoundry/dea.html";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//limengyun.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    </div>
    
  </article>
</section>
        <section id="extras" class="body">
                        <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                                                    <li><a href="http://getpelican.com/">Pelican</a></li>
                                                    <li><a href="http://python.org/">Python.org</a></li>
                                                    <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                                                    <li><a href="/pages/markdown-syntax.html">Markdown Syntax</a></li>
                                                </ul>
                </div><!-- /.blogroll -->
                                <div class="social">
                        <h2>友情链接</h2>
                        <ul>
                            <li><a href="http://limengyun.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://huihui.cn/?keyfrom=limengyun.com">网易惠惠</a></li>
                                                    <li><a href="http://www.xiaoshuov.com">xiaoshuov</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>&copy; copyright 2013. <a href="http://limengyun.com">limengyun.com</a>, thanks for visiting!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37781337-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'limengyun';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>